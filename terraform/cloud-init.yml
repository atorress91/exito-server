#cloud-config

# No instalar Docker (ya viene pre-instalado en la imagen docker-20-04)
package_update: true

packages:
  - git
  - curl
  - jq
  - wget

runcmd:
  # Asegurar que Docker estÃ¡ corriendo
  - systemctl start docker
  - systemctl enable docker

  # Configurar variables de entorno necesarias
  - export HOME=/root
  - export XDG_CONFIG_HOME=/root/.config

  # Instalar doctl
  - wget -q -O /tmp/doctl.tar.gz https://github.com/digitalocean/doctl/releases/download/v1.104.0/doctl-1.104.0-linux-amd64.tar.gz
  - tar -xzf /tmp/doctl.tar.gz -C /tmp
  - mv /tmp/doctl /usr/local/bin/
  - chmod +x /usr/local/bin/doctl

  # Autenticar con DigitalOcean Registry usando HOME definido
  - HOME=/root /usr/local/bin/doctl auth init -t "${do_token}"
  - HOME=/root /usr/local/bin/doctl registry login

  # Pull de la imagen
  - docker pull registry.digitalocean.com/${docker_image}:${docker_tag}

  # Detener y eliminar contenedor si existe
  - docker stop exitojuntos-app 2>/dev/null || true
  - docker rm exitojuntos-app 2>/dev/null || true

  # Ejecutar contenedor
  - docker run -d --name exitojuntos-app --restart unless-stopped -p ${app_port}:${app_port} -e NODE_ENV=${node_env} -e PORT=${app_port} -e DATABASE_URL="${database_url}" -e JWT_SECRET="${jwt_secret}" -e JWT_EXPIRES_IN="${jwt_expires_in}" registry.digitalocean.com/${docker_image}:${docker_tag}

  # Esperar y verificar logs
  - sleep 10
  - docker ps
  - docker logs exitojuntos-app --tail 50

write_files:
  - path: /usr/local/bin/update-app.sh
    content: |
      #!/bin/bash
      export HOME=/root
      export XDG_CONFIG_HOME=/root/.config
      /usr/local/bin/doctl auth init -t "${do_token}"
      /usr/local/bin/doctl registry login
      docker pull registry.digitalocean.com/${docker_image}:${docker_tag}
      docker stop exitojuntos-app
      docker rm exitojuntos-app
      docker run -d --name exitojuntos-app --restart unless-stopped -p ${app_port}:${app_port} -e NODE_ENV=${node_env} -e PORT=${app_port} -e DATABASE_URL="${database_url}" -e JWT_SECRET="${jwt_secret}" -e JWT_EXPIRES_IN="${jwt_expires_in}" registry.digitalocean.com/${docker_image}:${docker_tag}
    permissions: '0755'

final_message: 'Exitojuntos deployed at http://$INSTANCE_IP:${app_port}'
